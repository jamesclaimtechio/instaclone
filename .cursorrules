# .cursorrules

# Instagram Clone - AI Development Rules

> A photo-sharing social platform with Instagram-like mechanics built with Next.js, Drizzle ORM, and Cloudflare R2.

---

## âš¡ QUICK REFERENCE (Read This First!)

### ğŸ”´ Critical Rules (Will Break App If Violated)

| # | Rule | Why |
|---|------|-----|
| 1 | Use **Drizzle ORM**, NOT Prisma | TypeScript-native, no codegen, AI-friendly |
| 5 | **EXACTLY 6 tables** (users, posts, comments, likes, follows, otp_codes) | Architecture constraint |
| 6 | All images â†’ **3 sizes** (thumb 400px, full 1200px, blur 20px) | Performance requirement |
| 16 | **JWT in httpOnly cookies**, NOT localStorage | Security requirement |
| 17 | **All Server Actions MUST check auth** (getCurrentUser()) | Security requirement |

### ğŸŸ¡ Important Rules (Will Cause Issues Later)

| # | Rule | Impact |
|---|------|--------|
| 3 | **Optimistic UI mandatory** (useOptimistic hook) | UX requirement |
| 7 | **Feed is GLOBAL** (not filtered by follows) | Architecture decision |
| 8 | **Comments are FLAT** (no nesting) | Data model constraint |
| 9 | **Username is PERMANENT** | Cannot change after registration |
| 13 | **Cascade deletes** (post â†’ likes + comments) | Data integrity |

### ğŸŸ¢ Preferred Patterns (Best Practice)

- Server Components by default (#2)
- Server Actions over API routes
- shadcn/ui over component libraries
- PostgreSQL ILIKE for search (not full-text)

---

## ğŸ“š Documentation Navigation

**Need to find something?**

| Looking for... | Check... |
|----------------|----------|
| System design & patterns | `ARCHITECTURE` |
| Database structure | `DATABASE_SCHEMA` |
| External API setup | `API_CONTRACTS` |
| Where to find code patterns | `TASK_ROUTER` |
| Environment variables | `ENV_SETUP` |
| Error solutions | `TROUBLESHOOTING` |
| Getting started | `QUICK_START` |
| Current module | `Implementation Plan` |

---

## ğŸ› ï¸ Tech Stack

- **Framework:** Next.js (App Router, React 19)
- **Language:** TypeScript (strict mode)
- **Database:** Neon Postgres (serverless)
- **ORM:** Drizzle ORM
- **Storage:** Cloudflare R2 (S3-compatible)
- **Image Processing:** Sharp
- **Auth:** Custom (bcrypt + jose JWT)
- **Email:** Resend
- **Styling:** Tailwind CSS
- **Components:** shadcn/ui (Radix primitives)
- **Deployment:** Vercel

---

## ğŸ”´ CRITICAL RULES

### Database & ORM

**#1 - Use Drizzle ORM, NOT Prisma**  
ğŸ”´ **CRITICAL** - AI code generation is more reliable with Drizzle's TypeScript-native schema. No codegen step means faster iterations.

**#5 - Database has EXACTLY 6 tables**  
ğŸ”´ **CRITICAL** - Do not add tables beyond: users, posts, comments, likes, follows, otp_codes. No audit tables, no logging tables. Keep it simple.

### Architecture Patterns

**#2 - Server Components by default**  
ğŸŸ¢ **PREFERRED** - Only use Client Components when you need interactivity (forms, useOptimistic, event handlers). Server Components reduce bundle size and improve performance.

**#3 - Optimistic UI is MANDATORY for social actions**  
ğŸŸ¡ **IMPORTANT** - Likes, comments, follows MUST use React 19's `useOptimistic` hook. Immediate UI feedback is critical for perceived performance.

**#4 - Use React 19's `useOptimistic`, NOT custom implementations**  
ğŸŸ¡ **IMPORTANT** - This project explicitly requires React 19 features. Do not implement manual optimistic UI patterns.

### Image Handling

**#6 - All images go to R2 in 3 sizes**  
ğŸ”´ **CRITICAL** - Every image upload MUST generate: thumbnail (400px), full-size (1200px), and blur placeholder (20px base64). Use Sharp for processing.

**#18 - Profile pictures use same upload pipeline as posts**  
ğŸŸ¢ **PREFERRED** - No separate upload logic. Profile pictures go through Sharp â†’ R2 pipeline, stored as single URL (no thumbnail needed).

### Feed & Social Features

**#7 - Feed is GLOBAL, not filtered by follows**  
ğŸŸ¡ **IMPORTANT** - The feed shows ALL posts from ALL users in chronological order. Follow system is for counts only in MVP.

**#8 - Comments are FLAT, not nested**  
ğŸŸ¡ **IMPORTANT** - No reply threads. All comments at same level, newest first. Master spec explicitly forbids nested replies.

**#20 - Follower/following counts only, NO lists**  
ğŸŸ¡ **IMPORTANT** - Master spec explicitly excludes clickable follower/following lists. Show counts only. Do not build list views.

### User Management

**#9 - Username is PERMANENT**  
ğŸŸ¡ **IMPORTANT** - Users cannot change username after registration. Username uniqueness is enforced at database and application level.

**#10 - Email verification blocks posting, not viewing**  
ğŸŸ¡ **IMPORTANT** - Unverified users can browse feed and profiles but cannot post, like, or comment until OTP verified.

**#11 - No password requirements**  
ğŸŸ¢ **PREFERRED** - Accept ANY password. Master spec explicitly states no length/complexity requirements. Hash everything with bcrypt cost 12.

**#12 - Caption has NO character limit**  
ğŸŸ¢ **PREFERRED** - Post captions can be any length. Master spec explicitly states unlimited.

### Data Integrity

**#13 - Post deletion cascades to likes AND comments**  
ğŸŸ¡ **IMPORTANT** - When post deleted, database MUST cascade delete all associated likes and comments. When user deleted, cascade to ALL their content.

### Admin & Moderation

**#14 - Admin can delete ANYTHING**  
ğŸŸ¡ **IMPORTANT** - Admin users (isAdmin=true) can delete any post, comment, or user. No restrictions. Show confirmation dialogs.

### Search

**#15 - Search is username-only with ILIKE**  
ğŸŸ¢ **PREFERRED** - User search uses PostgreSQL ILIKE for case-insensitive partial matching on username field ONLY. Max 10 results. Index on username required.

### Authentication & Security

**#16 - JWT in HTTP-only cookies, NOT localStorage**  
ğŸ”´ **CRITICAL** - Session tokens MUST be httpOnly, secure, sameSite cookies. Never store JWT in localStorage or expose to client JavaScript.

**#17 - All Server Actions MUST revalidate auth**  
ğŸ”´ **CRITICAL** - Every server action that modifies data MUST call getCurrentUser() to verify authentication. Never trust client state.

**#19 - OTP codes expire in 15 minutes**  
ğŸŸ¡ **IMPORTANT** - Email verification OTPs MUST expire. Check expiration in database before validating. Resend invalidates previous codes.

---

## ğŸ”’ Security Rules

### Secrets & Environment (ğŸ”´ CRITICAL)

- **NEVER hardcode** API keys, database URLs, R2 credentials, JWT secrets, or any sensitive values
- **ALL sensitive values MUST come from** environment variables (.env.local in dev, Vercel env vars in production)
- **NEVER log secrets** or include them in error messages. Log generic errors only.
- **NEVER commit .env files** â€” Only commit .env.example with placeholder values
- **R2 credentials** (access key ID, secret access key) MUST be server-only. Never expose to client.
- **JWT secret** MUST be cryptographically random (min 32 bytes) and never exposed

### Input Validation (ğŸŸ¡ IMPORTANT)

- **ALWAYS validate user input on the server**, even if validated on client. Client validation is for UX only.
- **NEVER trust client-side data** for security decisions. Re-verify everything in Server Actions.
- **Sanitize** all user input before database queries (Drizzle handles this with parameterized queries)
- **Validate file uploads:** Check type (image/*), size (max 50MB), and validate with Sharp before storing
- **Email validation:** Format check before registration and OTP send
- **Username validation:** Alphanumeric + underscore only, check uniqueness before registration
- **Minimum comment length:** 1 character (reject empty strings, trim whitespace)

### Authentication & Authorization (ğŸ”´ CRITICAL)

- **ALWAYS check authentication** on protected API routes and Server Actions before processing
- **ALWAYS verify user has permission** before any data operation (check userId matches or isAdmin=true)
- **Use middleware** for auth checks on route groups, not inline code in every page
- **Session tokens MUST be** httpOnly, secure (HTTPS only), and sameSite=strict
- **JWT expiration** is 30 days. Enforce in middleware validation.
- **Password hashing** with bcrypt cost factor 12 (never lower)
- **OTP verification** required before user can post, like, or comment

### Data Access (ğŸŸ¡ IMPORTANT)

- **ALWAYS filter queries by userId** for user-specific data (posts, likes, comments, follows) to prevent IDOR
- **Check ownership before update/delete** â€” Verify current user owns resource OR is admin
- **Post deletion** â€” Only post author or admin can delete
- **Comment deletion** â€” Only comment author, post author, or admin can delete
- **Follow/unfollow** â€” User cannot follow themselves (check in UI and backend)
- **No negative counts** â€” Follower, following, like counts cannot go below zero
- **Cascade deletes** configured at database level (foreign keys with ON DELETE CASCADE)

### Error Handling (ğŸŸ¢ PREFERRED)

- **NEVER expose stack traces** to users in production. Show generic messages.
- **Log errors server-side** with context (user ID, action, timestamp), but show generic errors to users
- **Return consistent error formats** â€” Do not leak implementation details
- **Handle all promise rejections** and async errors. Every Server Action needs try-catch.
- **Network errors** â€” Show user-friendly messages: "Connection error. Please try again."
- **Database errors** â€” Log details, show "Something went wrong. Please try again."

### API Security (ğŸŸ¡ IMPORTANT)

- **Validate R2 uploads** â€” Check file type and size before processing
- **Validate email OTP codes** â€” Check code matches, not expired, and belongs to correct user
- **Implement rate limiting** on OTP verification (max 5 attempts per 15 minutes)
- **CSRF protection** â€” Built into Next.js Server Actions (verify enabled)
- **Set security headers** â€” X-Content-Type-Options: nosniff, X-Frame-Options: DENY
- **R2 bucket** must have public read for images, but upload requires authentication
- **Email service API keys** server-side only, never exposed to client

---

## ğŸ¯ Technology Choices (Why We Use What We Use)

| Instead of... | We use... | Because... |
|---------------|-----------|------------|
| Prisma | **Drizzle ORM** | TypeScript-native schema, no codegen step, better for AI |
| Browser resize | **Sharp** | Server-side processing ensures consistent quality |
| AWS S3 | **Cloudflare R2** | Zero egress fees, S3-compatible API |
| NextAuth/Clerk | **Custom auth** | Learning project, manual implementation required |
| SendGrid | **Resend** | Simpler API, better DX, sufficient for transactional email |
| jsonwebtoken | **jose JWT** | Modern, edge-compatible, smaller bundle |
| argon2 | **bcrypt** | Simpler, widely supported, sufficient for MVP |
| Chakra/MUI | **shadcn/ui** | Copy-paste components, no runtime dependency |
| CSS Modules | **Tailwind** | Utility-first, faster iteration, AI-friendly |
| API routes | **Server Actions** | Collocated with components, simpler architecture |
| Full-text search | **PostgreSQL ILIKE** | Simpler for username search, sufficient for MVP |

---

## âš ï¸ Common Mistakes to Avoid

### Database (ğŸ”´ CRITICAL)
- âŒ Adding "future feature" fields to database schema â†’ Keep minimal
- âŒ Adding more than 6 database tables â†’ Architecture constraint
- âŒ Not using indexes on username, email, post.userId â†’ Performance issues
- âŒ Soft delete â†’ Use hard deletes with cascade

### Security (ğŸ”´ CRITICAL)
- âŒ Using localStorage for JWT tokens â†’ Use HTTP-only cookies
- âŒ Trusting client-side like/follow state â†’ Always query database
- âŒ Exposing R2 credentials to client â†’ Server-only
- âŒ Forgetting to check email verification â†’ Check emailVerified flag

### Architecture (ğŸŸ¡ IMPORTANT)
- âŒ Implementing nested comment replies â†’ Explicitly forbidden
- âŒ Building follower/following list pages â†’ Out of scope, counts only
- âŒ Filtering feed by followed users â†’ Feed is global in MVP
- âŒ Client-side image resizing â†’ Server-side with Sharp only
- âŒ Not handling optimistic UI rollback â†’ Must handle failures

### Scope Creep (ğŸŸ¢ WATCH FOR)
- âŒ Adding hashtag functionality â†’ Out of scope for MVP
- âŒ Implementing post editing â†’ Out of scope, deletion only
- âŒ Building stories/reels â†’ Not in spec
- âŒ Direct messaging â†’ Not in spec

---

## ğŸ“ File Organisation

```
app/
â”œâ”€â”€ (auth)/           # Auth routes (login, register)
â”œâ”€â”€ (main)/           # Protected routes (feed, profile)
â”œâ”€â”€ admin/            # Admin dashboard
â”œâ”€â”€ actions/          # Server Actions by feature
â”‚   â”œâ”€â”€ auth.ts
â”‚   â”œâ”€â”€ posts.ts
â”‚   â”œâ”€â”€ comments.ts
â”‚   â””â”€â”€ follows.ts
â”œâ”€â”€ layout.tsx
â””â”€â”€ page.tsx

src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/           # shadcn components
â”‚   â”œâ”€â”€ posts/        # Post components
â”‚   â”œâ”€â”€ profile/      # Profile components
â”‚   â””â”€â”€ feed/         # Feed components
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ schema.ts     # All 6 tables
â”‚   â”œâ”€â”€ index.ts      # Database client
â”‚   â””â”€â”€ migrations/   # Generated migrations
â””â”€â”€ lib/
    â”œâ”€â”€ auth.ts       # Auth utilities
    â”œâ”€â”€ r2.ts         # R2 client
    â”œâ”€â”€ image.ts      # Sharp processing
    â””â”€â”€ utils.ts      # Shared utilities

middleware.ts         # Auth route protection
```

---

## ğŸ“¦ Dependency Rules

### âŒ DO NOT Install
- Prisma (use Drizzle)
- NextAuth/Clerk (custom auth)
- Redux/Zustand (use React 19 hooks)
- Other image libraries (use Sharp only)

### âœ… DO Install
- Only shadcn/ui components actually used
- Dependencies from approved tech stack

### ğŸ“Œ Package Manager
- **Always use `pnpm`** (not npm or yarn)
- Pin versions in package.json

---

## ğŸ”„ Versioning Rules

### Documentation
- âœ… Reference features/APIs, not version numbers
- âœ… `pnpm add [package]` â€” installs latest
- âŒ `pnpm add next@14.0.0` â€” don't pin in docs

### Before Building
```bash
pnpm outdated  # Check for stale packages
pnpm update    # Update to latest compatible
```

---

## ğŸ“ Learning Resources

When you encounter unfamiliar patterns:

- **Drizzle ORM:** https://orm.drizzle.team/docs
- **Next.js App Router:** https://nextjs.org/docs
- **React 19 useOptimistic:** https://react.dev/reference/react/useOptimistic
- **Cloudflare R2:** https://developers.cloudflare.com/r2/
- **Resend:** https://resend.com/docs

---

**Last Updated:** This file reflects the complete Instagram Clone specification as of project initialization.
